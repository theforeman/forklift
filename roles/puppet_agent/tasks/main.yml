---
- name: Manage puppet package
  ansible.builtin.package:
    name: "{{ puppet_agent_package_name }}"
    state: "{{ puppet_agent_package_state }}"
  when: puppet_agent_package_manage

- name: Ensure puppet group
  ansible.builtin.group:
    name: "{{ puppet_agent_group_name }}"
    state: "{{ puppet_agent_group_state }}"
  when: puppet_agent_group_manage

- name: Puppet ssl bootstrap
  when: puppet_agent_bootstrap_manage
  block:
    # This makes sure 'sudo puppet' works which is needed for bootstrapping
    - name: Setup sudo secure_path
      ansible.builtin.copy:
        content: "Defaults secure_path = \"/sbin:/bin:/usr/sbin:/usr/bin:/opt/puppetlabs/bin\"\n"
        dest: /etc/sudoers.d/puppet

    - name: Construct puppet ssl bootstrap command
      ansible.builtin.set_fact:
        puppet_agent_bootstrap_command: "puppet ssl bootstrap --waitforcert {{ puppet_agent_bootstrap_waitforcert }}"

    - name: Add server option
      ansible.builtin.set_fact:
        puppet_agent_bootstrap_command: "{{ puppet_agent_bootstrap_command }} --server {{ puppet_agent_bootstrap_server }}"
      when: puppet_agent_bootstrap_server is defined

    - name: Run puppet ssl boostrap command
      ansible.builtin.command: "{{ puppet_agent_bootstrap_command }}"
