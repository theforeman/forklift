---
- name: 'Clone the dynflow repository'
  ansible.builtin.git:
    repo: https://github.com/Dynflow/dynflow.git
    dest: ~/dynflow
    update: no
    remote: upstream

- name: 'Check if the fork remote exists'
  ansible.builtin.shell: "git remote | grep ^{{ dynflow_devel_github_fork_remote_name }}$"
  args:
    chdir: ~/dynflow
  ignore_errors: yes
  register: fork_remote_exists

- name: 'Add fork remote to cloned repository'
  ansible.builtin.command: "git remote add {{ dynflow_devel_github_fork_remote_name }} git@github.com:{{ dynflow_devel_github_username }}/dynflow.git"
  when: fork_remote_exists.rc != 0
  args:
    chdir: ~/dynflow

- name: 'Install gem native dependencies'
  become: true
  ansible.builtin.yum:
    name:
      - gcc-c++
      - postgresql-devel
      - sqlite-devel
    state: present

- name: 'Install bundler'
  community.general.gem: name=bundler state=present

- name: 'Install gems'
  community.general.bundler: chdir=~/dynflow state=present executable=~/bin/bundle
