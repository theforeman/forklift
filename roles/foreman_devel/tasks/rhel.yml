---
- name: "Check the registration"
  ansible.builtin.shell: "subscription-manager identity > /dev/null"
  register: sresult
  become: true
  ignore_errors: True

- name: "Stop installation; the system is not registered"
  ansible.builtin.fail:
    msg: "Please register the system via subscription-manager before continuing"
  when: "sresult.rc != 0"

- name: "Disable all repos"
  community.general.rhsm_repository:
    name: "*"
    state: "disabled"

- name: "Enable only RHEL7 base + optional + extras repos"
  community.general.rhsm_repository:
    name: "{{ item }}"
    state: "present"
  become: true
  with_items:
      - rhel-7-server-rpms
      - rhel-7-server-extras-rpms
      - rhel-7-server-optional-rpms
