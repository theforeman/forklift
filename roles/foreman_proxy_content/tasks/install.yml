---
- name: 'Gather facts from {{ foreman_proxy_content_server }}'
  ansible.builtin.setup:
  delegate_to: "{{ foreman_proxy_content_server }}"
  delegate_facts: true

- name: 'Get Server Hostname'
  ansible.builtin.set_fact:
    server_fqdn: "{{ hostvars[foreman_proxy_content_server].ansible_nodename }}"

- name: 'Get Foreman settings'
  ansible.builtin.slurp:
    src: "{{ foreman_directory }}/settings.yaml"
  delegate_to: "{{ foreman_proxy_content_server }}"
  register: foreman_settings

- name: 'Get OAuth consumer data from settings'
  ansible.builtin.set_fact:
    oauth_consumer_key: "{{ foreman_settings_yaml[':oauth_consumer_key'] }}"
    oauth_consumer_secret: "{{ foreman_settings_yaml[':oauth_consumer_secret'] }}"
  vars:
    foreman_settings_yaml: "{{ (foreman_settings['content'] | b64decode | from_yaml) }}"

- ansible.builtin.include_tasks: certs_generate.yml

- name: 'Change cert permissions'
  ansible.builtin.file: path='/etc/pki/katello/private' mode=0775
  delegate_to: "{{ foreman_proxy_content_server }}"
  when: devel is defined and devel

- name: 'Install Capsule Installer RPM'
  ansible.builtin.yum:
    name: foreman-proxy-content
  when: not custom_install
