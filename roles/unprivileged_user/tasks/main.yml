---
- name: "Set group name"
  ansible.builtin.set_fact:
    unprivileged_user_groupname: "{{ unprivileged_user_primary_group | default(unprivileged_user_username) }}"

- name: "Create groups"
  ansible.builtin.group:
    name: "{{ item }}"
    state: present
  with_items: "{{ unprivileged_user_additional_groups + [unprivileged_user_groupname] }}"
  become: true

- name: "Create the {{ unprivileged_user_username }} user"
  ansible.builtin.user:
    name: "{{ unprivileged_user_username }}"
    groups: "{{ unprivileged_user_additional_groups + [unprivileged_user_groupname] }}"
    append: yes
  become: true

- name: "Grant passwordless sudo via {{ unprivileged_user_groupname }} group"
  community.general.sudoers:
    name: "{{ unprivileged_user_groupname }}"
    group: "{{ unprivileged_user_groupname }}"
    commands: ALL
  become: true

- name: "Add public key to authorized_keys from Host Machine"
  ansible.posix.authorized_key:
    user: "{{ unprivileged_user_username }}"
    state: present
    key: "{{ lookup('file', unprivileged_user_import_ssh_pub_key) }}"
  when: unprivileged_user_import_ssh_pub_key | default(False)
  become: true

- name: "Add public key to authorized_keys via GitHub"
  ansible.posix.authorized_key:
    user: "{{ unprivileged_user_username }}"
    state: present
    key: "https://github.com/{{ unprivileged_user_import_ssh_pub_key_github }}.keys"
  when: unprivileged_user_import_ssh_pub_key_github | default(False)
  become: true

- name: "Check /home/{{ unprivileged_user_username }}/.ssh/authorized_keys"
  ansible.builtin.stat:
    path: /home/{{ unprivileged_user_username }}/.ssh/authorized_keys
  register: authorized_keys_file
  become: true

- name: "Inherit authorized_keys from root user if none imported for {{ unprivileged_user_username }}"
  block:
    - name: "Check /root/.ssh/authorized_keys"
      ansible.builtin.stat:
        path: /root/.ssh/authorized_keys
      register: root_authorized_keys_file

    - name: "Copy /root/.ssh/authorized_keys"
      ansible.builtin.copy:
        remote_src: true
        src:  /root/.ssh/authorized_keys
        owner: "{{ unprivileged_user_username }}"
        mode: 0600
        dest: "/home/{{ unprivileged_user_username }}/.ssh/authorized_keys"
      when: root_authorized_keys_file.stat.exists

  when:
    - not authorized_keys_file.stat.exists
    - unprivileged_user_import_ssh_pub_key | default(True)
  become: true

- name: "Configure {{ unprivileged_user_username }} for Kerberos authentication"
  block:
    - name: "Install krb5-workstation on Red Hat based distributions"
      ansible.builtin.dnf:
        name:
          - "krb5-workstation"
          - "krb5-libs"
        state: present
      when: ansible_os_family == "RedHat"

    - name: "Install krb5-user on Debian based distributions"
      ansible.builtin.apt:
        name: "krb5-user"
        state: present
      when: ansible_os_family == "Debian"

    - name: "Copy Kerberos client config from Host"
      ansible.builtin.copy:
        src: "{{ unprivileged_user_kerberos_copy_config }}"
        dest: /etc/krb5.conf
        owner: root
        group: root
        mode: '0644'
      when: unprivileged_user_kerberos_copy_config

    - name: "Copy Kerberos Credential Cache from Host"
      ansible.builtin.copy:
        src: "{{ unprivileged_user_kerberos_copy_ccache }}"
        dest: "{{ unprivileged_user_kerberos_copy_ccache }}"
        owner: "{{ unprivileged_user_username }}"
        group: "{{ unprivileged_user_groupname }}"
        mode: '0600'
      when: unprivileged_user_kerberos_copy_ccache

  when: unprivileged_user_kerberos_install
  become: true
