---
# Make sure admin does not default to any taxonomy
- name: 'disable default context for admin'
  # TODO: how to pass org and location IDs 0 to FAM?
  shell: >
    {{ foreman_provisioning_hammer }} user update --login admin --default-organization-id 0 --default-location-id 0

- name: 'Set taxonomies for proxy'
  theforeman.foreman.smart_proxy:
    name: "{{ foreman_provisioning_proxy_name }}"
    organizations:
      - "{{ foreman_provisioning_organization }}"
    locations:
      - "{{ foreman_provisioning_location }}"

- name: 'create compute resource'
  theforeman.foreman.compute_resource:
    name: "libvirt"
    url: "qemu:///system"
    provider: libvirt
    set_console_password: false

- name: 'create domain'
  theforeman.foreman.domain:
    name: "{{ foreman_provisioning_domain }}"
    dns_proxy: "{{ foreman_provisioning_proxy_name }}"
    organizations:
      - "{{ foreman_provisioning_organization }}"
    locations:
      - "{{ foreman_provisioning_location }}"

- name: 'create subnet'
  theforeman.foreman.subnet:
    name: "{{ foreman_provisioning_network }}/{{ foreman_provisioning_network_cidr }}"
    dhcp_proxy: "{{ foreman_provisioning_smart_proxy }}"
    dns_proxy: "{{ foreman_provisioning_smart_proxy }}"
    tftp_proxy: "{{ foreman_provisioning_smart_proxy }}"
    domains:
      - "{{ foreman_provisioning_domain }}"
    from_ip: "{{ foreman_provisioning_dhcp_start }}"
    to_ip: "{{ foreman_provisioning_dhcp_end }}"
    network: "{{ foreman_provisioning_network }}"
    cidr: "{{ foreman_provisioning_network_cidr }} "
    ipam: DHCP
    gateway: "{{ foreman_provisioning_ip_address }}"
    dns_primary: "{{ foreman_provisioning_ip_address }}"
    organizations:
      - "{{ foreman_provisioning_organization }}"
    locations:
      - "{{ foreman_provisioning_location }}"

- name: 'create Puppet environment'
  theforeman.foreman.puppet_environment:
    name: production
    organizations:
      - "{{ foreman_provisioning_organization }}"
    locations:
      - "{{ foreman_provisioning_location }}"

# query local nameservers http://projects.theforeman.org/issues/13419
- name: 'query local nameservers'
  theforeman.foreman.setting:
    name: query_local_nameservers
    value: true
