---
- name: 'Install koji package'
  ansible.builtin.yum:
    name: 'koji'
    state: 'present'

- name: 'Make repo directory'
  ansible.builtin.file:
    path: '{{ koji_repo_directory }}'
    state: 'directory'

- name: 'Download RPMs from tasks'
  ansible.builtin.command: "koji --server {{ koji_host }} --topurl {{ koji_topurl }} download-task {{ item }}"
  args:
    chdir: "{{ koji_repo_directory }}"
  with_items: "{{ koji_task_ids }}"

- name: 'Download RPMs from builds'
  ansible.builtin.command: "koji --server {{ koji_host }} --topurl {{ koji_topurl }} download-build {{ item }}"
  args:
    chdir: "{{ koji_repo_directory }}"
  with_items: "{{ koji_build_ids }}"

- name: 'Install createrepo'
  ansible.builtin.yum:
    name: 'createrepo'
    state: 'present'

- name: 'Create repo'
  ansible.builtin.command: "createrepo {{ koji_repo_directory }}"

- name: 'Add repo file'
  ansible.builtin.yum_repository:
    name: "koji-forklift-task-repo"
    description: 'Local repository for Koji task RPMs'
    baseurl: "file://{{ koji_repo_directory }}"
    file: "koji_forklift_task_repo"
    priority: 1
    enabled: yes
    gpgcheck: no
